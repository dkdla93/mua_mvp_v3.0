<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileProcessor í…ŒìŠ¤íŠ¸ ì‹¤í–‰ê¸°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 4px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        .test-results {
            font-family: monospace;
            white-space: pre-wrap;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            max-height: 500px;
            overflow-y: auto;
            font-size: 12px;
        }
        .summary-box {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .error-box {
            background: #fff5f5;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .pass { color: #28a745; font-weight: bold; }
        .fail { color: #dc3545; font-weight: bold; }
        .category-header {
            font-size: 14px;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0 5px 0;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“‹ FileProcessor ì¢…í•© í…ŒìŠ¤íŠ¸</h1>
        <p>íŒŒì¼ ì—…ë¡œë“œ ë° ì²˜ë¦¬ ê¸°ëŠ¥ì„ ê²€ì¦í•©ë‹ˆë‹¤.</p>
    </div>

    <div class="test-container">
        <div class="test-controls">
            <button class="btn btn-primary" onclick="runTests()">ğŸš€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
            <button class="btn btn-secondary" onclick="clearResults()">ğŸ—‘ï¸ ê²°ê³¼ ì§€ìš°ê¸°</button>
            <button class="btn btn-secondary" onclick="exportResults()">ğŸ’¾ ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</button>
        </div>

        <div id="progress-section" style="display: none;">
            <div class="progress">
                <div class="progress-bar" id="progress-bar" style="width: 0%">0%</div>
            </div>
            <div id="current-test" style="margin: 10px 0; font-weight: bold;"></div>
        </div>

        <div id="summary-section"></div>

        <div class="test-results" id="test-output"></div>
    </div>

    <!-- í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" crossorigin="anonymous"></script>
    <script src="public/js/polyfills/polyfills.js"></script>
    <script src="public/js/utils/worker-manager.js"></script>
    <script src="public/js/utils/file-processor.js"></script>
    <script src="file-processor-test.js"></script>

    <script>
        let testOutput = '';
        let testStartTime = null;

        // console.log ì˜¤ë²„ë¼ì´ë“œí•˜ì—¬ ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œ
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            const message = args.join(' ');
            testOutput += message + '\n';
            updateTestDisplay();
        };

        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            const message = 'âŒ ERROR: ' + args.join(' ');
            testOutput += message + '\n';
            updateTestDisplay();
        };

        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            const message = 'âš ï¸ WARN: ' + args.join(' ');
            testOutput += message + '\n';
            updateTestDisplay();
        };

        function updateTestDisplay() {
            const outputElement = document.getElementById('test-output');
            if (outputElement) {
                outputElement.textContent = testOutput;
                outputElement.scrollTop = outputElement.scrollHeight;
            }
        }

        function updateProgress(current, total, currentTest = '') {
            const progressBar = document.getElementById('progress-bar');
            const currentTestElement = document.getElementById('current-test');
            const progressSection = document.getElementById('progress-section');

            if (progressBar && total > 0) {
                const percentage = Math.round((current / total) * 100);
                progressBar.style.width = percentage + '%';
                progressBar.textContent = percentage + '%';
                progressSection.style.display = 'block';

                if (currentTestElement) {
                    currentTestElement.textContent = currentTest || `ì§„í–‰ì¤‘... ${current}/${total}`;
                }
            }
        }

        function displaySummary(results) {
            const summarySection = document.getElementById('summary-section');
            const { summary, detailed } = results;

            const successRate = Math.round((summary.totalPassed / summary.totalTests) * 100);
            const testDuration = testStartTime ? Math.round((Date.now() - testStartTime) / 1000) : 0;

            let summaryHtml = `
                <div class="${successRate >= 80 ? 'summary-box' : 'error-box'}">
                    <h3>ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½</h3>
                    <p><strong>ì „ì²´ í…ŒìŠ¤íŠ¸:</strong> ${summary.totalTests}ê°œ</p>
                    <p><strong>ì„±ê³µ:</strong> <span class="pass">${summary.totalPassed}ê°œ</span></p>
                    <p><strong>ì‹¤íŒ¨:</strong> <span class="fail">${summary.totalFailed}ê°œ</span></p>
                    <p><strong>ì„±ê³µë¥ :</strong> ${successRate}%</p>
                    <p><strong>ì‹¤í–‰ ì‹œê°„:</strong> ${testDuration}ì´ˆ</p>
                </div>

                <div class="summary-box">
                    <h4>ğŸ” ì¹´í…Œê³ ë¦¬ë³„ ê²°ê³¼</h4>
            `;

            Object.entries(detailed).forEach(([category, result]) => {
                const categorySuccess = Math.round((result.passed / result.tests) * 100) || 0;
                summaryHtml += `
                    <div class="category-header">
                        ${getCategoryIcon(category)} ${getCategoryName(category)}:
                        <span class="${result.failed === 0 ? 'pass' : 'fail'}">
                            ${result.passed}/${result.tests} (${categorySuccess}%)
                        </span>
                    </div>
                `;
            });

            summaryHtml += '</div>';
            summarySection.innerHTML = summaryHtml;
        }

        function getCategoryIcon(category) {
            const icons = {
                excel: 'ğŸ“Š',
                image: 'ğŸ–¼ï¸',
                validation: 'âœ…',
                largeFile: 'ğŸ’¾',
                worker: 'âš™ï¸'
            };
            return icons[category] || 'ğŸ“‹';
        }

        function getCategoryName(category) {
            const names = {
                excel: 'Excel ì²˜ë¦¬',
                image: 'ì´ë¯¸ì§€ ì²˜ë¦¬',
                validation: 'íŒŒì¼ ê²€ì¦',
                largeFile: 'ëŒ€ìš©ëŸ‰ íŒŒì¼',
                worker: 'Web Worker'
            };
            return names[category] || category;
        }

        async function runTests() {
            testOutput = '';
            testStartTime = Date.now();

            document.getElementById('summary-section').innerHTML = '';
            document.getElementById('test-output').textContent = '';

            console.log('ğŸ¯ FileProcessor ì¢…í•© í…ŒìŠ¤íŠ¸ ì‹œì‘');
            console.log('='.repeat(50));

            try {
                updateProgress(0, 5, 'í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì¤‘...');

                // í•„ìš”í•œ ê°ì²´ë“¤ì´ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (typeof runAllTests !== 'function') {
                    throw new Error('í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                if (typeof fileProcessor === 'undefined') {
                    throw new Error('FileProcessor ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                updateProgress(1, 5, 'Excel íŒŒì¼ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸...');

                const results = await runAllTests();

                updateProgress(5, 5, 'í…ŒìŠ¤íŠ¸ ì™„ë£Œ!');

                if (results.error) {
                    throw new Error(results.error);
                }

                displaySummary(results);

                console.log('âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ ì™„ë£Œ!');

            } catch (error) {
                console.error('í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨:', error.message);
                document.getElementById('summary-section').innerHTML = `
                    <div class="error-box">
                        <h3>âŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì˜¤ë¥˜</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function clearResults() {
            testOutput = '';
            document.getElementById('test-output').textContent = '';
            document.getElementById('summary-section').innerHTML = '';
            document.getElementById('progress-section').style.display = 'none';
        }

        function exportResults() {
            if (!testOutput) {
                alert('ë‚´ë³´ë‚¼ í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `file-processor-test-results-${timestamp}.txt`;

            const blob = new Blob([testOutput], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();

            URL.revokeObjectURL(url);
        }

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸° ìƒíƒœ í™•ì¸
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ í…ŒìŠ¤íŠ¸ í™˜ê²½ í™•ì¸ ì¤‘...');

            // í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
            const requiredObjects = {
                'XLSX': typeof XLSX !== 'undefined',
                'FileProcessor': typeof FileProcessor !== 'undefined',
                'fileProcessor (ì¸ìŠ¤í„´ìŠ¤)': typeof fileProcessor !== 'undefined',
                'WorkerManager': typeof WorkerManager !== 'undefined',
                'Worker ì§€ì›': typeof Worker !== 'undefined'
            };

            console.log('ğŸ“‹ í™˜ê²½ ì²´í¬ ê²°ê³¼:');
            Object.entries(requiredObjects).forEach(([name, available]) => {
                console.log(`  ${available ? 'âœ…' : 'âŒ'} ${name}: ${available ? 'ì‚¬ìš©ê°€ëŠ¥' : 'ì‚¬ìš©ë¶ˆê°€'}`);
            });

            console.log('\nì¤€ë¹„ ì™„ë£Œ! "í…ŒìŠ¤íŠ¸ ì‹¤í–‰" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
        });
    </script>
</body>
</html>