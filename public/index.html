<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>착공도서 자동생성 시스템</title>
    <link rel="stylesheet" href="styles.css">

    <!-- Browser Compatibility Polyfills (IE11+ support) -->
    <script src="js/polyfills/polyfills.js"></script>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pptxgenjs/3.12.0/pptxgen.bundle.min.js" crossorigin="anonymous"></script>

    <!-- Fallback 라이브러리 체크 -->
    <script>
        // XLSX 라이브러리 폴백
        if (typeof XLSX === 'undefined') {
            console.warn('XLSX 라이브러리 로딩 실패 - 엑셀 기능이 제한될 수 있습니다');
            window.XLSX = {
                utils: { sheet_to_json: function() { return []; } },
                read: function() { return { SheetNames: [], Sheets: {} }; }
            };
        }

        // PptxGenJS 라이브러리 폴백
        if (typeof PptxGenJS === 'undefined') {
            console.warn('PptxGenJS 라이브러리 로딩 실패 - PPT 생성 기능이 제한될 수 있습니다');
            window.PptxGenJS = function() {
                return {
                    addSlide: function() { return { addText: function() {} }; },
                    save: function() { console.warn('PPT 생성 기능이 비활성화되어 있습니다'); }
                };
            };
        }
    </script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>착공도서 자동생성 시스템</h1>
            <p class="subtitle">인테리어 공사 착공도서를 자동으로 생성해보세요</p>
        </header>

        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step active" data-step="1">
                <span class="step-number">1</span>
                <span class="step-title">파일 업로드</span>
            </div>
            <div class="step" data-step="2">
                <span class="step-number">2</span>
                <span class="step-title">공정 관리</span>
            </div>
            <div class="step" data-step="3">
                <span class="step-number">3</span>
                <span class="step-title">매칭 & 배치</span>
            </div>
            <div class="step" data-step="4">
                <span class="step-number">4</span>
                <span class="step-title">생성 & 다운로드</span>
            </div>
        </div>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Step 1: File Upload -->
            <section id="step-1" class="step-content active">
                <h2>1단계: 파일 업로드</h2>

                <!-- Excel Upload -->
                <div class="upload-section">
                    <h3>엑셀 자재표</h3>
                    <div class="file-upload-area" id="excel-upload">
                        <input type="file" id="excel-file" accept=".xlsx,.xls" style="display: none;">
                        <div class="upload-placeholder">
                            <div class="upload-icon">📊</div>
                            <p>엑셀 파일을 선택하거나 드래그하세요</p>
                            <p class="file-info">.xlsx, .xls 형식 (최대 50MB)</p>
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('excel-file').click()">
                                파일 선택
                            </button>
                        </div>
                        <div class="file-status" id="excel-status" style="display: none;"></div>
                    </div>
                </div>

                <!-- Minimap Upload -->
                <div class="upload-section">
                    <h3>미니맵 이미지</h3>
                    <div class="file-upload-area" id="minimap-upload">
                        <input type="file" id="minimap-file" accept="image/*" style="display: none;">
                        <div class="upload-placeholder">
                            <div class="upload-icon">🗺️</div>
                            <p>미니맵 이미지를 선택하거나 드래그하세요</p>
                            <p class="file-info">.jpg, .png, .gif 형식 (최대 50MB)</p>
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('minimap-file').click()">
                                파일 선택
                            </button>
                        </div>
                        <div class="file-status" id="minimap-status" style="display: none;"></div>
                    </div>
                </div>

                <!-- Scene Images Upload -->
                <div class="upload-section">
                    <h3>장면 이미지들</h3>
                    <div class="file-upload-area" id="scenes-upload">
                        <input type="file" id="scenes-files" accept="image/*" multiple style="display: none;">
                        <div class="upload-placeholder">
                            <div class="upload-icon">🏠</div>
                            <p>장면 이미지들을 선택하거나 드래그하세요</p>
                            <p class="file-info">.jpg, .png, .gif 형식 (다중 선택 가능, 최대 50MB)</p>
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('scenes-files').click()">
                                파일 선택
                            </button>
                        </div>
                        <div class="file-status" id="scenes-status" style="display: none;"></div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="step-navigation">
                    <button type="button" class="btn btn-secondary" disabled>이전</button>
                    <button type="button" class="btn btn-primary" id="next-step-1" disabled>다음</button>
                </div>
            </section>

            <!-- Step 2: Process Management (공정 관리) -->
            <section id="step-2" class="step-content">
                <h2>2단계: 공정 관리</h2>
                <div class="process-tabs" id="process-tabs">
                    <!-- 공정 탭들이 여기 동적으로 생성됩니다 -->
                </div>
                <div class="process-content" id="process-content">
                    <!-- 공정별 장면 선택 내용이 여기 표시됩니다 -->
                </div>

                <div class="step-navigation">
                    <button type="button" class="btn btn-secondary" id="prev-step-2">이전</button>
                    <button type="button" class="btn btn-primary" id="next-step-2" disabled>다음</button>
                </div>
            </section>

            <!-- Step 3: Material Mapping & Placement -->
            <section id="step-3" class="step-content">
                <h2>3단계: 매칭 & 자재 배치</h2>
                <div class="workspace" id="workspace">
                    <!-- 작업 공간이 여기 구성됩니다 -->
                </div>

                <div class="step-navigation">
                    <button type="button" class="btn btn-secondary" id="prev-step-3">이전</button>
                    <button type="button" class="btn btn-primary" id="next-step-3" disabled>다음</button>
                </div>
            </section>

            <!-- Step 4: Generate & Download -->
            <section id="step-4" class="step-content">
                <h2>4단계: 생성 & 다운로드</h2>
                <div class="preview-area" id="preview-area">
                    <!-- PPT 미리보기가 여기 표시됩니다 -->
                </div>

                <div class="step-navigation">
                    <button type="button" class="btn btn-secondary" id="prev-step-4">이전</button>
                    <button type="button" class="btn btn-success" id="generate-ppt" disabled>PPT 생성</button>
                </div>
            </section>
        </main>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading-overlay" style="display: none;">
            <div class="loading-content">
                <div class="spinner"></div>
                <p id="loading-message">처리 중입니다...</p>
            </div>
        </div>

        <!-- Error Modal -->
        <div class="modal" id="error-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>오류 발생</h3>
                    <button type="button" class="modal-close" onclick="closeModal('error-modal')">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="error-message"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="closeModal('error-modal')">확인</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Core System (Phase 1) -->
    <script src="js/core/constants.js"></script>
    <script src="js/core/module-loader.js"></script>
    <script src="js/core/app-core.js"></script>

    <!-- Utility Libraries -->
    <script src="js/utils/event-manager.js"></script>
    <script src="js/utils/file-processor.js"></script>
    <script src="js/utils/state-manager.js"></script>
    <script src="js/utils/coordinate-system.js"></script>
    <script src="js/utils/worker-manager.js"></script>

    <!-- Refactored Managers (Phase 2) -->
    <script src="js/managers/file-upload-manager.js"></script>
    <script src="js/managers/process-manager.js"></script>
    <script src="js/managers/workspace-manager.js"></script>
    <script src="js/managers/drag-drop-manager.js"></script>

    <!-- Main Application -->
    <script src="app.js"></script>

    <!-- Application Initialization -->
    <script>
        // 새로운 코어 시스템으로 애플리케이션 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('🚀 새로운 코어 시스템으로 애플리케이션 초기화 시작...');

                // AppCore 초기화
                const initSuccess = await AppCore.initialize();

                if (initSuccess) {
                    console.log('✅ 애플리케이션 초기화 완료');

                    // 기존 시스템과의 호환성을 위한 초기화 호출
                    if (typeof initializeNavigationSystem === 'function') {
                        initializeNavigationSystem();
                    }
                    if (typeof fileUploadManager !== 'undefined' && fileUploadManager.init) {
                        fileUploadManager.init();
                    }

                    // 성능 정보 출력 (개발 모드에서만)
                    if (AppConfig.get('DEBUG.ENABLED', false)) {
                        console.table(AppCore.getPerformanceInfo());
                        console.log('모듈 정보:', ModuleLoader.getInfo());
                    }
                } else {
                    throw new Error('애플리케이션 초기화 실패');
                }
            } catch (error) {
                console.error('💥 애플리케이션 초기화 중 오류:', error);

                // 폴백: 기존 시스템으로 초기화
                console.log('🔄 기존 시스템으로 폴백 초기화 시도...');
                try {
                    if (typeof initializeNavigationSystem === 'function') {
                        initializeNavigationSystem();
                    }
                    if (typeof fileUploadManager !== 'undefined' && fileUploadManager.init) {
                        fileUploadManager.init();
                    }
                    console.log('✅ 폴백 초기화 완료');
                } catch (fallbackError) {
                    console.error('💥 폴백 초기화도 실패:', fallbackError);
                    alert('시스템 초기화에 실패했습니다. 페이지를 새로고침해주세요.');
                }
            }
        });

        // 개발자 도구에서 사용할 수 있는 디버그 함수들
        if (AppConfig.get('DEBUG.ENABLED', false)) {
            window.debugApp = {
                getState: () => AppCore.getState(),
                getPerformance: () => AppCore.getPerformanceInfo(),
                getModules: () => ModuleLoader.getInfo(),
                getBootLog: () => AppCore.debug.getBootLog(),
                getErrors: () => AppCore.debug.getErrors()
            };
            console.log('🔧 디버그 도구 사용 가능: debugApp 객체를 콘솔에서 사용하세요');
        }
    </script>
</body>
</html>